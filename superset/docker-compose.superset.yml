version: "3.8"

services:
  superset:
    image: apache/superset:latest
    container_name: superset
    env_file:
      - ../.env.superset
    environment:
      SUPERSET_ENV: production
      SUPERSET_LOAD_EXAMPLES: "no"
      SUPERSET_SECRET_KEY: ${SUPERSET_SECRET_KEY}
      SQLALCHEMY_DATABASE_URI: ${SUPERSET_DB_URI}
    volumes:
      - superset_home:/app/superset_home
    depends_on:
      - superset-db
      - superset-redis
    ports:
      - "8088:8088"
    command: >
      bash -c "
        superset db upgrade &&
        superset fab create-admin
          --username ${SUPERSET_ADMIN_USER}
          --firstname Admin
          --lastname User
          --email ${SUPERSET_ADMIN_EMAIL}
          --password ${SUPERSET_ADMIN_PASSWORD} || true &&
        superset init &&
        gunicorn -w 4 -k gevent --timeout 120
          -b 0.0.0.0:8088 'superset.app:create_app()'
      "

  superset-db:
    image: postgres:15-alpine
    container_name: superset-db
    environment:
      POSTGRES_DB: superset
      POSTGRES_USER: superset
      POSTGRES_PASSWORD: superset
    volumes:
      - superset_db:/var/lib/postgresql/data

  superset-redis:
    image: redis:7-alpine
    container_name: superset-redis
    volumes:
      - superset_redis:/data

volumes:
  superset_home:
  superset_db:
  superset_redis:
