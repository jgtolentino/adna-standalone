name: Backend Verification

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  verify-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --ignore-scripts || npm install --legacy-peer-deps
      continue-on-error: true

    - name: Run static backend verification
      run: |
        if [ -f "./verify-backend-strict.sh" ]; then
          chmod +x ./verify-backend-strict.sh
          ./verify-backend-strict.sh || echo "::warning::Static verification had warnings"
        else
          echo "::warning::verify-backend-strict.sh not found"
        fi
      continue-on-error: true

    - name: Start application
      run: |
        # Try to start the scout dashboard
        npm run dev:scout &
        APP_PID=$!

        # Wait for app to be ready (max 30 seconds)
        for i in {1..30}; do
          if curl -s http://localhost:3000 > /dev/null 2>&1; then
            echo "App started successfully"
            break
          fi
          sleep 1
        done

        # Keep PID for cleanup
        echo "APP_PID=$APP_PID" >> $GITHUB_ENV
      env:
        NEXT_PUBLIC_SUPABASE_URL: "https://placeholder.supabase.co"
        NEXT_PUBLIC_SUPABASE_ANON_KEY: "placeholder-anon-key-for-ci"
        NEXT_PUBLIC_USE_MOCK: "0"
        CI: "true"
        SKIP_ENV_VALIDATION: "true"
      continue-on-error: true

    - name: Install Playwright
      run: npx playwright install chromium --with-deps
      continue-on-error: true

    - name: Run live backend verification
      run: |
        if [ -f "./verify-backend-live-strict.js" ]; then
          node verify-backend-live-strict.js || echo "::warning::Live verification had issues"
        else
          echo "::warning::verify-backend-live-strict.js not found"
        fi
      continue-on-error: true
      
    - name: Upload verification report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-verification-report
        path: |
          backend-verification-strict-report.json
        if-no-files-found: ignore
          
    - name: Comment PR with results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      continue-on-error: true
      with:
        script: |
          const fs = require('fs');

          let comment;
          try {
            if (fs.existsSync('backend-verification-strict-report.json')) {
              const report = JSON.parse(fs.readFileSync('backend-verification-strict-report.json', 'utf8'));

              comment = `## üîç Backend Verification Results

              **Verdict:** ${report.verdict}

              | Metric | Value |
              |--------|-------|
              | Total API Calls | ${report.apiCalls?.length || 0} |
              | Mock Patterns | ${report.mockDetections?.length || 0} |
              | Workflows Tested | ${report.workflows?.length || 0} |

              ${report.verdict === 'REAL_BACKEND_CONFIRMED' ? '‚úÖ Real backend integration confirmed!' : '‚ö†Ô∏è Review required - see full report'}
              `;
            } else {
              comment = `## üîç Backend Verification Results

              ‚ö†Ô∏è Verification report not generated. Check workflow logs for details.
              `;
            }
          } catch (e) {
            comment = `## üîç Backend Verification Results

            ‚ö†Ô∏è Error reading verification report: ${e.message}
            `;
          }

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });