name: Dashboard Compatibility CI

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'supabase/migrations/**'
      - 'components/**'
      - 'tests/**'
      - 'scripts/**'
      - '.github/workflows/dashboard-compatibility-ci.yml'
  push:
    branches: [ dashboard-compatibility-layer ]

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

jobs:
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        working-directory: ./apps/scout-dashboard
        run: npm ci --ignore-scripts || npm install --legacy-peer-deps
        continue-on-error: true

      - name: Run ESLint
        working-directory: ./apps/scout-dashboard
        run: npm run lint || echo "::warning::ESLint found issues"
        continue-on-error: true

      - name: TypeScript check
        working-directory: ./apps/scout-dashboard
        run: npm run type-check || echo "::warning::TypeScript check found issues"
        continue-on-error: true

      - name: SQL lint (sqlfluff)
        if: hashFiles('supabase/migrations/**/*.sql') != ''
        uses: sqlfluff/sqlfluff-github-actions@main
        with:
          paths: './supabase/migrations'
          dialect: 'postgres'
        continue-on-error: true

  db-validate:
    name: Database Validation
    runs-on: ubuntu-latest
    needs: [lint]
    # Only run if database secrets are available
    if: ${{ secrets.SUPABASE_DB_URL != '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_DB_URL }}" ]; then
            echo "::warning::SUPABASE_DB_URL not set, skipping database validation"
            exit 0
          fi

      - name: Setup PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Validate database connectivity
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
        run: |
          psql "${{ secrets.SUPABASE_DB_URL }}" -c "SELECT 1;" || echo "::warning::Database connectivity check failed"
        continue-on-error: true

      - name: Run migration validation
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
        run: |
          if [ -f "scripts/validate-dashboard-compatibility.sh" ]; then
            chmod +x scripts/validate-dashboard-compatibility.sh
            PG_URL_SCOUT="${{ secrets.SUPABASE_DB_URL }}" ./scripts/validate-dashboard-compatibility.sh full || echo "::warning::Migration validation had issues"
          else
            echo "::notice::validate-dashboard-compatibility.sh not found"
          fi
        continue-on-error: true

      - name: Test RPC functions with real data
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
        run: |
          if [ -f "scripts/test-rpc-production.sh" ]; then
            chmod +x scripts/test-rpc-production.sh
            PG_URL_SCOUT="${{ secrets.SUPABASE_DB_URL }}" ./scripts/test-rpc-production.sh || echo "::warning::RPC tests had issues"
          else
            echo "::notice::test-rpc-production.sh not found"
          fi
        continue-on-error: true

      - name: Validate governance badge
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
        run: |
          if [ -f "scripts/verify-governance-badge.sql" ]; then
            psql "${{ secrets.SUPABASE_DB_URL }}" -f scripts/verify-governance-badge.sql || echo "::warning::Governance badge validation had issues"
          else
            echo "::notice::verify-governance-badge.sql not found"
          fi
        continue-on-error: true

  test-e2e:
    name: E2E Testing
    runs-on: ubuntu-latest
    needs: [db-validate]
    # Make this job not fail if db-validate was skipped
    if: always() && needs.lint.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        working-directory: ./apps/scout-dashboard
        run: npm ci --ignore-scripts || npm install --legacy-peer-deps
        continue-on-error: true

      - name: Install Playwright browsers
        run: npx playwright install --with-deps
        continue-on-error: true

      - name: Start development server
        working-directory: ./apps/scout-dashboard
        run: |
          npm run dev &
          # Wait up to 60 seconds for server to start
          npx wait-on http://localhost:3000 --timeout 60000 || echo "::warning::Server did not start in time"
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ env.SUPABASE_URL || 'https://placeholder.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY || 'placeholder-key' }}
          CI: 'true'
          SKIP_ENV_VALIDATION: 'true'
        continue-on-error: true

      - name: Run Playwright tests
        working-directory: ./apps/scout-dashboard
        run: npx playwright test || echo "::warning::Some Playwright tests failed"
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ env.SUPABASE_URL || 'https://placeholder.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY || 'placeholder-key' }}
        continue-on-error: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
          if-no-files-found: ignore

  mcp-health:
    name: MCP Server Health Check
    runs-on: ubuntu-latest
    # Only run if Supabase secrets are available
    if: ${{ env.SUPABASE_URL != '' && env.SUPABASE_ANON_KEY != '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Supabase MCP connectivity
        run: |
          if [ -z "${{ env.SUPABASE_URL }}" ]; then
            echo "::warning::SUPABASE_URL not set, skipping MCP health check"
            exit 0
          fi
          curl -sf "${{ env.SUPABASE_URL }}/rest/v1/" \
            -H "apikey: ${{ env.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ env.SUPABASE_ANON_KEY }}" || echo "::warning::MCP connectivity check failed"
        continue-on-error: true

      - name: Test RPC endpoints
        run: |
          if [ -z "${{ env.SUPABASE_URL }}" ]; then
            exit 0
          fi
          curl -sf "${{ env.SUPABASE_URL }}/rest/v1/rpc/get_data_source_status" \
            -X POST \
            -H "apikey: ${{ env.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ env.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}' || echo "::warning::RPC endpoint check failed"
        continue-on-error: true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  performance-test:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [db-validate]
    steps:
      - uses: actions/checkout@v4

      - name: Setup PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Performance benchmark - CAG functions (<1.2s)
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
        run: |
          start_time=$(date +%s%N)
          psql "${{ secrets.SUPABASE_DB_URL }}" -c "SELECT * FROM scout.get_geo_summary('{}');" > /dev/null
          end_time=$(date +%s%N)
          duration_ms=$(( (end_time - start_time) / 1000000 ))
          echo "Geographic Summary: ${duration_ms}ms"
          if [ $duration_ms -gt 1200 ]; then
            echo "FAIL: Geographic Summary exceeded 1200ms target"
            exit 1
          fi

      - name: Performance benchmark - RAG functions (<3s)
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
        run: |
          start_time=$(date +%s%N)
          psql "${{ secrets.SUPABASE_DB_URL }}" -c "SELECT * FROM scout.get_financial_metrics('{}');" > /dev/null
          end_time=$(date +%s%N)
          duration_ms=$(( (end_time - start_time) / 1000000 ))
          echo "Financial Metrics: ${duration_ms}ms"
          if [ $duration_ms -gt 3000 ]; then
            echo "FAIL: Financial Metrics exceeded 3000ms target"
            exit 1
          fi

  deployment-ready:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    needs: [lint, db-validate, test-e2e, mcp-health, performance-test]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Check CI results
        run: |
          echo "üìä CI Check Summary"
          echo "==================="
          echo "Lint: ${{ needs.lint.result }}"
          echo "DB Validate: ${{ needs.db-validate.result }}"
          echo "E2E Tests: ${{ needs.test-e2e.result }}"
          echo "MCP Health: ${{ needs.mcp-health.result }}"
          echo "Performance: ${{ needs.performance-test.result }}"
          echo ""

          # Check if critical jobs passed
          if [ "${{ needs.lint.result }}" = "success" ]; then
            echo "‚úÖ Lint: PASS"
          else
            echo "‚ö†Ô∏è Lint: ${{ needs.lint.result }}"
          fi

          # Report overall status
          echo ""
          echo "üöÄ CI checks completed - review results above"